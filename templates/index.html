<!DOCTYPE html>
<html class="dark" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAG Chatbot</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- Markdown rendering (marked) + sanitization (DOMPurify) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#7f0df2",
              "background-dark": "#191022",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>

    <style>
      body {
        background-color: #0a0a0a;
        background-image: radial-gradient(circle at 10% 20%, rgba(138, 43, 226, 0.2) 0%, transparent 40%),
          radial-gradient(circle at 80% 90%, rgba(75, 0, 130, 0.2) 0%, transparent 40%);
        backdrop-filter: blur(10px);
      }

      .glass-card {
        background-color: rgba(25, 16, 34, 0.6);
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        border: 1px solid rgba(127, 13, 242, 0.2);
      }

      .glow-edge {
        transition: box-shadow 0.3s ease-in-out;
      }

      .glow-edge:hover,
      .glow-edge:focus-within {
        box-shadow: 0 0 20px 5px rgba(127, 13, 242, 0.3);
      }

      /* Drag-and-drop highlight */
      .drop-active {
        border-color: rgba(127, 13, 242, 0.9) !important;
        background: rgba(127, 13, 242, 0.08);
      }

      /* Brand heading effects */
      .brand-title {
        position: relative;
        background: linear-gradient(90deg, #c8a3ff, #7f0df2, #c8a3ff);
        background-size: 200% 100%;
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 0 6px rgba(127, 13, 242, 0.25), 0 0 14px rgba(127, 13, 242, 0.18);
        animation: gradientShift 8s linear infinite, glowPulse 3s ease-in-out infinite;
      }

      /* Reflection removed */

      @keyframes glowPulse {
        0%, 100% {
          text-shadow: 0 0 6px rgba(127, 13, 242, 0.28), 0 0 16px rgba(127, 13, 242, 0.2);
        }
        50% {
          text-shadow: 0 0 12px rgba(127, 13, 242, 0.5), 0 0 26px rgba(127, 13, 242, 0.38);
        }
      }

      @keyframes gradientShift {
        0% { background-position: 0% center; }
        100% { background-position: 200% center; }
      }
    </style>
  </head>

  <body class="font-display text-white">
    <div class="min-h-screen flex flex-col items-center justify-center p-4">
      <div class="w-full max-w-2xl flex flex-col gap-6">

        <!-- Flash messages -->
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for msg in messages %}
        <div class="flash-msg rounded-lg bg-purple-900/40 border border-purple-700/50 text-center p-3 text-sm transition-opacity duration-500">{{ msg }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Upload Tile -->
        <div class="glass-card glow-edge rounded-xl p-6 flex flex-col items-center text-center">
          <h1 class="text-3xl font-bold brand-title">DocuMind</h1>
          <p class="text-white/70 text-sm mt-2">Your intelligent document assistant.</p>

          <form id="uploadForm" method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data" class="w-full mt-4">
            <div id="dropZone" class="flex flex-col items-center justify-center border-2 border-dashed border-purple-600/40 rounded-xl py-8 gap-3 transition-colors"
              tabindex="0" role="button" aria-label="Drop PDF here or click Upload PDF">
              <span class="material-symbols-outlined text-primary text-4xl">upload_file</span>
              <p class="font-semibold">Drag & Drop PDF here</p>
              <p class="text-white/60 text-sm">or</p>
              <input type="file" name="file" accept="application/pdf" class="hidden" id="pdfInput" required />
              <label for="pdfInput" class="cursor-pointer bg-primary hover:bg-primary/90 px-6 py-2 rounded-lg text-white font-medium mt-2">Upload PDF</label>
            </div>
          </form>
          <!-- <p class="text-white/50 text-xs mt-3">Files are stored under <code>ragchatbot/data</code>.</p> -->
        </div>

        <!-- Chat Tile -->
        <div class="glass-card glow-edge rounded-xl p-5">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <div class="h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center">
                <span class="material-symbols-outlined text-primary">auto_awesome</span>
              </div>
              <p class="text-primary text-sm font-medium">AI Assistant</p>
            </div>
            <form method="post" action="{{ url_for('clear_chat') }}">
              <button type="submit" class="text-xs px-3 py-1.5 rounded-md border border-primary/40 text-primary hover:bg-primary/15 hover:border-primary/60 transition-colors shadow-[0_0_0_1px_rgba(127,13,242,0.25)]">
                Clear Chat
              </button>
            </form>
          </div>

          <!-- Document selector -->
          <div class="mb-3">
            <label for="source" class="block text-xs text-white/60 mb-1">Document</label>
            <form method="post" action="{{ url_for('ask') }}" class="contents">
              <select id="source" name="source" class="h-10 w-full bg-background-dark border border-white/20 rounded-lg px-3 text-sm text-white focus:ring-1 focus:ring-primary outline-none">
                <option value="__all__" {% if selected_source == '__all__' %}selected{% endif %}>All documents</option>
                {% for f in pdf_files %}
                  <option value="{{ f }}" {% if selected_source == f %}selected{% endif %}>{{ f }}</option>
                {% endfor %}
              </select>
            </form>
          </div>

          <!-- Messages -->
          <div class="flex flex-col gap-3 max-h-[42vh] overflow-y-auto pr-2">
            {% if messages %}
              {% for m in messages %}
                {% if m.role == 'user' %}
                  <div class="flex justify-end">
                    <div class="max-w-[80%] bg-primary/20 border border-primary/30 rounded-2xl px-4 py-2">{{ m.content }}</div>
                  </div>
                {% else %}
                  <div class="flex justify-start">
                    <div class="max-w-[80%] bg-background-dark border border-white/10 rounded-2xl px-4 py-2">
                      <div class="prose prose-invert max-w-none" data-md="{{ m.content|e }}"></div>
                      {% if m.sources %}
                        <div class="mt-2 text-xs text-white/70">
                          <strong>Sources:</strong>
                          <ul class="list-disc list-inside">
                            {% for s in m.sources %}
                              <li><code>{{ s }}</code></li>
                            {% endfor %}
                          </ul>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            {% else %}
              <div class="text-white/70 text-sm">No messages yet. Ask something to get started.</div>
            {% endif %}
          </div>

          <!-- Chat Input -->
          <form method="post" action="{{ url_for('ask') }}" class="mt-3 flex items-center gap-2">
            <input type="hidden" name="source" value="{{ selected_source }}" />
            <input type="text" name="question" placeholder="Ask anything about the document..."
              class="flex-1 bg-background-dark border border-white/20 rounded-lg px-4 h-11 text-white placeholder:text-white/50 focus:ring-1 focus:ring-primary outline-none"
              required />
            <button type="submit"
              class="h-11 px-4 rounded-lg bg-primary/80 hover:bg-primary text-white border border-white/20 transition-colors shadow-[0_4px_14px_rgba(127,13,242,0.25)] flex items-center justify-center gap-1">
              <span class="material-symbols-outlined text-white text-2xl leading-none">send</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </body>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const blocks = document.querySelectorAll('[data-md]');
      blocks.forEach(block => {
        const raw = block.getAttribute('data-md') || '';
        const html = DOMPurify.sanitize(marked.parse(raw, { breaks: true }));
        block.innerHTML = html;
      });
      // Auto-submit upload when file selected
      const input = document.getElementById('pdfInput');
      const form = document.getElementById('uploadForm');
      if (input && form) {
        input.addEventListener('change', () => form.submit());
      }

      // Auto-dismiss flash messages after 15s with fade-out
      const flashes = document.querySelectorAll('.flash-msg');
      flashes.forEach((el) => {
        setTimeout(() => {
          el.style.opacity = '0';
          setTimeout(() => el.remove(), 600); // match duration-500
        }, 15000);
      });

      // Drag & drop upload support
      const dropZone = document.getElementById('dropZone');
      if (dropZone && input && form) {
        const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };

        ['dragenter', 'dragover'].forEach(evt => {
          dropZone.addEventListener(evt, (e) => {
            prevent(e);
            dropZone.classList.add('drop-active');
          });
        });

        ['dragleave', 'dragend', 'drop'].forEach(evt => {
          dropZone.addEventListener(evt, (e) => {
            prevent(e);
            if (evt !== 'dragover') dropZone.classList.remove('drop-active');
          });
        });

        dropZone.addEventListener('drop', (e) => {
          const dt = e.dataTransfer;
          if (!dt || !dt.files || dt.files.length === 0) return;
          const file = Array.from(dt.files).find(f => f.type === 'application/pdf' || /\.pdf$/i.test(f.name));
          if (!file) {
            alert('Please drop a PDF file.');
            return;
          }
          // Assign only the chosen PDF to the hidden input
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          input.files = dataTransfer.files;
          form.submit();
        });
      }
    });
  </script>
</html>
